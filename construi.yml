image: lstephen/docker-push:9

default: build

environment:
  - DOCKER_PUSH_NAME=lstephen/construi
  - DOCKER_PUSH_EMAIL=levi.stephen@gmail.com
  - DOCKER_PUSH_USERNAME
  - DOCKER_PUSH_PASSWORD

volumes:
  - /var/run/docker.sock:/var/run/docker.sock

targets:
  version:
    environment:
      - CONSTRUI_INFO_URL=https://pypi.python.org/pypi/construi/json
    image: lstephen/versiune:5
    run: >
      -t "$version.$(curl -sS $CONSTRUI_INFO_URL | grep '\"version\"' | cut -d '\"' -f4)"
      VERSION

  build:
    before:
      - version
    run: build

  release:
    before:
      - version
    volumes:
      - $GIT_SSH_KEY:/ssh/id_rsa
    run: build release

